<div id="capiToast" class="capi-toast">
        <div class="toast-content">
            <span class="toast-icon">✅</span>
            <span id="toastMessage" class="toast-text">Account created!</span>
        </div>
    </div>

    <div id="phoneModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <div class="logo-container">
                <img src="images/logo-exprezzr.png" alt="Exprezzr Logo" class="logo-signup" style="height: 40px; width: auto; margin-bottom: 15px;">
                <h2 style="color: #f4d03f; font-family: 'Orbitron', sans-serif; font-size: 1.2rem;">ONE LAST STEP</h2>
                <p style="color: #ccc; font-size: 0.9rem;">Please provide your phone number to complete your CAPI profile.</p>
            </div>
            <div class="input-field-group" style="margin-top: 20px; text-align: left;">
                <label style="color: #f4d03f;">Phone Number</label>
                <div class="phone-input-wrapper">
                    <span class="country-code">+1</span>
                    <input type="tel" id="modalPhone" placeholder="(508) 000-0000" required>
                </div>
            </div>
            <button id="savePhoneBtn" class="btn-primary-signup" style="margin-top: 20px; width: 100%;">Complete Registration</button>
        </div>
    </div>

    <script>
        let tempGoogleUser = null;

        // Función de notificación profesional
        function showCapiToast(message, isError = false) {
            const toast = document.getElementById('capiToast');
            const toastMsg = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('.toast-icon');

            toastMsg.innerText = message;
            
            if (isError) {
                toast.classList.add('toast-error');
                toastIcon.innerText = "❌";
            } else {
                toast.classList.remove('toast-error');
                toastIcon.innerText = "✅";
            }

            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 4000);
        }

        // 1. Manejo de Google Auth
        function handleCredentialResponse(response) {
            fetch('/auth/google', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: response.credential })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showCapiToast(data.error, true);
                    return;
                }
                
                // Si falta teléfono, activar Modal
                if (!data.user.phone || data.user.phone === 'Not provided' || data.user.phone === 'Pending') {
                    tempGoogleUser = data.user;
                    const modal = document.getElementById('phoneModal');
                    modal.style.display = 'flex';
                    // Pequeño delay para la animación CSS
                    setTimeout(() => modal.classList.add('active'), 10);
                } else {
                    showCapiToast("Welcome back to CAPI, " + data.user.firstName);
                    setTimeout(() => window.location.href = '/dashboard', 1500); 
                }
            })
            .catch(err => showCapiToast("Google Auth Failed", true));
        }

        // 2. Guardar teléfono del Modal
        document.getElementById('savePhoneBtn').addEventListener('click', async (e) => {
            e.preventDefault(); // Evita recargas accidentales
            const phoneValue = document.getElementById('modalPhone').value;
            if (!phoneValue) return showCapiToast("Please enter your phone number", true);

            try {
                const response = await fetch('/update-phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: tempGoogleUser.email, phone: phoneValue })
                });

                if (response.ok) {
                    showCapiToast("Profile completed! Welcome to Exprezzr.");
                    setTimeout(() => window.location.href = '/dashboard', 2000);
                }
            } catch (err) {
                showCapiToast("Error saving phone", true);
            }
        });

// LÍNEA CLAVE: Asegúrate de que el evento tenga el (e)
document.getElementById('signupForm').addEventListener('submit', async (event) => {
    // 1. Detener cualquier acción del navegador
    event.preventDefault();
    event.stopPropagation();

    console.log("Intentando registrar usuario..."); // Esto aparecerá en la consola del navegador (F12)

    // ... resto de tu código fetch ...
    
    e.preventDefault(); // <--- LÍNEA VITAL: Esto evita la pantalla blanca.

    // ... (Tu código para armar el objeto userData) ...

    try {
        const response = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
        });

        const result = await response.json(); // <--- LÍNEA CLAVE: Lee el JSON del servidor

        if(response.ok) {
            showCapiToast("Account created!"); // Muestra el letrero dorado
            setTimeout(() => { window.location.href = '/login'; }, 2000);
        } else {
            showCapiToast(result.error, true); // Muestra el letrero en rojo
        }
    } catch (error) {
        showCapiToast("Connection error", true);
    }
});    </script>